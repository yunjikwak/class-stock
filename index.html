<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학급 화폐 주식 매매 프로그램</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .tab-btn.active {
            background-color: #1D4ED8;
            color: white;
            font-weight: 700;
        }
        .timeframe-btn {
            @apply px-4 py-2 text-sm font-medium text-gray-600 bg-white rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500;
        }
        .timeframe-btn.active {
            @apply bg-indigo-600 text-white hover:bg-indigo-700;
        }
        .mode-btn {
            transition: background-color 0.2s, color 0.2s;
        }
        .mode-btn.active {
            background-color: #2563EB;
            color: white;
        }
        .mode-btn:not(.active) {
            background-color: #E5E7EB;
            color: #4B5563;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-8">

    <div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">

        <!-- 헤더 -->
        <header class="mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800 text-center">학급 화폐 주식 매매</h1>
            <div class="mt-4 p-4 bg-blue-50 rounded-lg flex justify-between items-center">
                <div>
                    <span class="text-lg font-semibold text-blue-800">나의 자산</span>
                    <span id="balance" class="text-2xl font-bold text-blue-900 ml-2">1,000.00 공기</span>
                </div>
                <button id="add-asset-btn" class="bg-blue-600 text-white font-bold w-10 h-10 text-xl rounded-full hover:bg-blue-700 transition duration-300 shadow-md flex items-center justify-center">+</button>
            </div>
        </header>

        <!-- 탭 메뉴 -->
        <div class="mb-6">
            <div class="flex border-b border-gray-300">
                <button id="tab-usd" class="tab-btn flex-1 py-3 px-4 text-lg font-medium text-gray-600 hover:bg-blue-100 transition duration-300 rounded-t-lg">
                    📈 원/달러 환율
                </button>
                <button id="tab-oil" class="tab-btn flex-1 py-3 px-4 text-lg font-medium text-gray-600 hover:bg-blue-100 transition duration-300 rounded-t-lg">
                    🛢️ 원유 가격
                </button>
            </div>
        </div>

        <!-- 주식 정보 및 거래 영역 -->
        <main id="stock-content" class="space-y-6">
            <!-- JS에 의해 동적으로 채워짐 -->
        </main>
        
        <!-- 예약 주문 현황 -->
        <div id="pending-orders-section" class="mt-6">
            <h3 class="text-xl font-bold text-gray-800 mb-3">예약 주문 현황</h3>
            <div id="pending-orders-list" class="bg-gray-50 p-4 rounded-lg max-h-48 overflow-y-auto">
                <p class="text-gray-500 text-center">예약된 주문이 없습니다.</p>
            </div>
        </div>

        <!-- 메시지 알림창 -->
        <div id="message-box" class="fixed bottom-5 right-5 bg-red-500 text-white py-3 px-5 rounded-lg shadow-xl opacity-0 transform translate-y-10 transition-all duration-500 z-50">
            <p id="message-text"></p>
        </div>
        
        <!-- 관리자 모달 -->
        <div id="admin-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                <form id="admin-form">
                    <h3 id="admin-modal-title" class="text-xl font-bold mb-4">관리자 코드 입력</h3>
                    <div id="admin-modal-content">
                        <!-- JS로 내용 주입 -->
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- 상태 관리 ---
        const state = {
            balance: 1000,
            activeStock: 'usd',
            activeTimeframe: '1M',
            tradeMode: 'quantity',
            stocks: {
                usd: { name: '원/달러 환율', icon: '📈', price: 100, owned: 0, totalPurchaseCost: 0, fullHistory: [], todayHistory: [] },
                oil: { name: '원유 가격', icon: '🛢️', price: 100, owned: 0, totalPurchaseCost: 0, fullHistory: [], todayHistory: [] }
            },
            pendingOrders: [],
            adminCode: '7293'
        };
        
        // --- 데이터 저장/불러오기 ---
        function saveState() {
            const dataToSave = {
                balance: state.balance,
                pendingOrders: state.pendingOrders,
                stocks: {
                    usd: { owned: state.stocks.usd.owned, totalPurchaseCost: state.stocks.usd.totalPurchaseCost },
                    oil: { owned: state.stocks.oil.owned, totalPurchaseCost: state.stocks.oil.totalPurchaseCost }
                }
            };
            localStorage.setItem('stockTraderState', JSON.stringify(dataToSave));
        }

        function loadState() {
            const savedStateJSON = localStorage.getItem('stockTraderState');
            if (savedStateJSON) {
                try {
                    const savedState = JSON.parse(savedStateJSON);
                    state.balance = savedState.balance || 1000;
                    state.pendingOrders = savedState.pendingOrders || [];
                    if (savedState.stocks) {
                        state.stocks.usd.owned = savedState.stocks.usd?.owned || 0;
                        state.stocks.usd.totalPurchaseCost = savedState.stocks.usd?.totalPurchaseCost || 0;
                        state.stocks.oil.owned = savedState.stocks.oil?.owned || 0;
                        state.stocks.oil.totalPurchaseCost = savedState.stocks.oil?.totalPurchaseCost || 0;
                    }
                } catch (e) {
                    console.error("저장된 데이터를 불러오는 데 실패했습니다.", e);
                    localStorage.removeItem('stockTraderState');
                }
            }
        }

        // --- 숫자 포맷팅 ---
        const formatCurrency = (value) => value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // --- DOM 요소 ---
        const balanceEl = document.getElementById('balance');
        const stockContentEl = document.getElementById('stock-content');
        const pendingOrdersListEl = document.getElementById('pending-orders-list');
        const tabUsdBtn = document.getElementById('tab-usd');
        const tabOilBtn = document.getElementById('tab-oil');
        const addAssetBtn = document.getElementById('add-asset-btn');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const adminModalOverlay = document.getElementById('admin-modal-overlay');
        const adminForm = document.getElementById('admin-form');
        const adminModalTitle = document.getElementById('admin-modal-title');
        const adminModalContent = document.getElementById('admin-modal-content');

        // --- 함수 ---

        function generateHistoricalData(days, base, volatility) {
            const data = [];
            let currentPrice = base;
            for (let i = 0; i < days; i++) {
                const change = (Math.random() - 0.49) * volatility;
                currentPrice += change;
                currentPrice = Math.max(currentPrice, base * 0.5);
                data.push(currentPrice);
            }
            return data;
        }

        function getDataForTimeframe(stockId, timeframe) {
            const stock = state.stocks[stockId];
            switch (timeframe) {
                case '1D': return stock.todayHistory;
                case '1W': return stock.fullHistory.slice(-7);
                case '1M': return stock.fullHistory.slice(-30);
                case '1Y': return stock.fullHistory.slice(-365);
                case 'ALL':
                default:
                    return stock.fullHistory;
            }
        }

        function showMessage(text, type = 'error') {
            messageText.textContent = text;
            messageBox.className = messageBox.className.replace(/bg-\w+-\d+/, type === 'success' ? 'bg-green-500' : 'bg-red-500');
            messageBox.classList.remove('opacity-0', 'translate-y-10');
            messageBox.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100', 'translate-y-0');
                messageBox.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        }

        function renderChart(stockId) {
            const priceHistory = getDataForTimeframe(stockId, state.activeTimeframe);
            const stock = state.stocks[stockId];
            const width = 500, height = 200, yPadding = 30, xPadding = 55;

            if (priceHistory.length < 2) return `<div class="flex items-center justify-center h-[${height}px]"><p>차트 데이터 부족</p></div>`;
            
            const avgPurchasePrice = stock.owned > 0 ? stock.totalPurchaseCost / stock.owned : 0;
            const pricesToShow = [...priceHistory, avgPurchasePrice > 0 ? avgPurchasePrice : -1];
            const validPrices = pricesToShow.filter(p => p > 0);
            const maxPrice = validPrices.length > 0 ? Math.max(...validPrices) : 1;
            const minPrice = validPrices.length > 0 ? Math.min(...validPrices) : 0;
            const priceRange = maxPrice - minPrice === 0 ? 1 : maxPrice - minPrice;

            const getX = i => xPadding + ((width - xPadding * 2) / (Math.max(1, priceHistory.length - 1))) * i;
            const getPriceY = p => height - yPadding - ((p - minPrice) / priceRange) * (height - yPadding * 2);

            let gridLines = '';
            const hGridCount = 4;
            for (let i = 0; i <= hGridCount; i++) {
                const y = yPadding + i * (height - yPadding * 2) / hGridCount;
                gridLines += `<line x1="${xPadding}" y1="${y}" x2="${width - xPadding}" y2="${y}" stroke="#e5e7eb"/>`;
                const pVal = maxPrice - i * (priceRange / hGridCount);
                gridLines += `<text x="${xPadding-8}" y="${y+4}" class="text-xs fill-gray-500" text-anchor="end">${pVal.toFixed(0)}</text>`;
            }

            const pricePoints = priceHistory.map((p, i) => `${getX(i)},${getPriceY(p)}`).join(' ');
            const lastIndex = priceHistory.length - 1;
            
            let avgPriceLine = '';
            if (avgPurchasePrice > 0 && avgPurchasePrice >= minPrice && avgPurchasePrice <= maxPrice) {
                 const avgY = getPriceY(avgPurchasePrice);
                 avgPriceLine = `<line x1="${xPadding}" y1="${avgY}" x2="${width - xPadding}" y2="${avgY}" stroke="#F59E0B" stroke-width="2" stroke-dasharray="5 5"/>`;
            }

            return `
                <div class="relative bg-white p-4 rounded-lg border border-gray-200">
                    <svg width="100%" viewBox="0 0 ${width} ${height}" class="overflow-visible">
                        ${gridLines}
                        ${avgPriceLine}
                        <polyline fill="none" stroke="#3B82F6" stroke-width="2.5" points="${pricePoints}"/>
                        <circle cx="${getX(lastIndex)}" cy="${getPriceY(priceHistory[lastIndex])}" r="4" fill="white" stroke="#1D4ED8" stroke-width="2"/>
                    </svg>
                </div>
                <div class="flex justify-center items-center space-x-6 mt-3 text-sm">
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-blue-500 mr-2"></span>주가</div>
                    <div class="flex items-center"><span class="w-4 h-0.5 border-t-2 border-yellow-500 border-dashed mr-2"></span>매수 평균가</div>
                </div>
            `;
        }
        
        function updateUI() {
            const tradeInput = document.getElementById('trade-input');
            const limitPriceInput = document.getElementById('limit-price-input');
            const tradeValue = tradeInput ? tradeInput.value : '';
            const limitPriceValue = limitPriceInput ? limitPriceInput.value : '';

            render();

            const newTradeInput = document.getElementById('trade-input');
            const newLimitPriceInput = document.getElementById('limit-price-input');
            if (newTradeInput) newTradeInput.value = tradeValue;
            if (newLimitPriceInput) newLimitPriceInput.value = limitPriceValue;
        }

        function render() {
            balanceEl.textContent = `${formatCurrency(state.balance)} 공기`;
            tabUsdBtn.classList.toggle('active', state.activeStock === 'usd');
            tabOilBtn.classList.toggle('active', state.activeStock === 'oil');

            const stock = state.stocks[state.activeStock];
            const isQuantityMode = state.tradeMode === 'quantity';

            const currentValuation = stock.owned * stock.price;
            const purchaseCost = stock.totalPurchaseCost;
            let profitPercent = 0, profitColor = 'text-gray-700', sign = '';
            if (purchaseCost > 0) { profitPercent = ((currentValuation - purchaseCost) / purchaseCost) * 100; }
            if (profitPercent > 0.001) { profitColor = 'text-red-600'; sign = '+'; } 
            else if (profitPercent < -0.001) { profitColor = 'text-blue-600'; }
            
            const timeframes = [ {id: '1D', name: '1일'}, {id: '1W', name: '1주'}, {id: '1M', name: '1달'}, {id: '1Y', name: '1년'}, {id: 'ALL', name: '전체'} ];

            stockContentEl.innerHTML = `
                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-700">${stock.icon} ${stock.name}</h2>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">현재가 (공기)</p>
                            <p id="current-price" class="text-3xl font-bold text-gray-900">${formatCurrency(stock.price)}</p>
                        </div>
                    </div>
                    <div class="mb-4 flex justify-center space-x-2">${timeframes.map(tf => `<button class="timeframe-btn ${state.activeTimeframe === tf.id ? 'active' : ''}" data-timeframe="${tf.id}">${tf.name}</button>`).join('')}</div>
                    <div id="chart-area" class="mb-6">${renderChart(state.activeStock)}</div>
                    <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                        <div class="flex justify-between items-center"><span class="font-medium text-gray-600">보유 수량</span><span class="text-lg font-bold text-gray-800">${stock.owned.toFixed(4)} 주</span></div>
                        <div class="flex justify-between items-center mt-2"><span class="font-medium text-gray-600">평가 금액</span><span class="text-lg font-bold text-gray-800">${formatCurrency(currentValuation)} 공기</span></div>
                        <div class="flex justify-between items-center mt-2 border-t pt-2 border-gray-200"><span class="font-medium text-gray-600">평가 손익</span><div class="text-right"><span class="text-lg font-bold ${profitColor}">${formatCurrency(currentValuation - purchaseCost)} 공기</span><span class="text-sm ml-1 font-semibold ${profitColor}">(${sign}${profitPercent.toFixed(2)}%)</span></div></div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="md:col-span-3">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="flex justify-between items-center mb-1"><label class="block text-sm font-medium">거래 단위</label><div class="flex"><button id="mode-quantity-btn" class="mode-btn px-3 py-1 text-xs rounded-l-md ${isQuantityMode ? 'active' : ''}">수량</button><button id="mode-amount-btn" class="mode-btn px-3 py-1 text-xs rounded-r-md ${!isQuantityMode ? 'active' : ''}">금액</button></div></div>
                                    <input type="number" id="trade-input" step="any" min="0" class="w-full px-4 py-2 border rounded-lg" placeholder="${isQuantityMode ? '수량(주)' : '금액(공기)'}">
                                </div>
                                <div>
                                    <label for="limit-price-input" class="block text-sm font-medium mb-1">예약 가격 (지정가)</label>
                                    <input type="number" id="limit-price-input" step="any" min="0" class="w-full px-4 py-2 border rounded-lg" value="${stock.price.toFixed(2)}">
                                </div>
                            </div>
                            <div class="mt-2 grid grid-cols-4 gap-2">${[0.1, 0.25, 0.5, 1.0].map(p => `<button class="percent-btn bg-gray-200 py-1.5 rounded-lg hover:bg-gray-300" data-percent="${p}">${p*100}%</button>`).join('')}</div>
                        </div>
                        <div class="md:col-span-2 flex items-end">
                            <div class="w-full grid grid-cols-2 gap-2">
                                <button id="instant-buy-btn" class="w-full bg-green-600 text-white font-bold py-2.5 rounded-lg hover:bg-green-700">즉시 매수</button>
                                <button id="instant-sell-btn" class="w-full bg-red-600 text-white font-bold py-2.5 rounded-lg hover:bg-red-700">즉시 매도</button>
                                <button id="limit-buy-btn" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 text-sm">매수 예약</button>
                                <button id="limit-sell-btn" class="w-full bg-pink-600 text-white font-bold py-2 rounded-lg hover:bg-pink-700 text-sm">매도 예약</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('instant-buy-btn').addEventListener('click', handleInstantBuy);
            document.getElementById('instant-sell-btn').addEventListener('click', handleInstantSell);
            document.getElementById('limit-buy-btn').addEventListener('click', handleLimitBuy);
            document.getElementById('limit-sell-btn').addEventListener('click', handleLimitSell);
            document.getElementById('mode-quantity-btn').addEventListener('click', () => switchTradeMode('quantity'));
            document.getElementById('mode-amount-btn').addEventListener('click', () => switchTradeMode('amount'));
            document.querySelectorAll('.percent-btn').forEach(btn => btn.addEventListener('click', e => setTradeInputByPercent(parseFloat(e.target.dataset.percent))));
            document.querySelectorAll('.timeframe-btn').forEach(btn => btn.addEventListener('click', e => switchTimeframe(e.target.dataset.timeframe)));
            renderPendingOrders();
        }

        function renderPendingOrders() {
            if (state.pendingOrders.length === 0) {
                pendingOrdersListEl.innerHTML = `<p class="text-gray-500 text-center">예약된 주문이 없습니다.</p>`; return;
            }
            pendingOrdersListEl.innerHTML = state.pendingOrders.map(order => {
                const stock = state.stocks[order.stockId];
                const typeText = order.type === 'buy' ? '매수' : '매도';
                const typeColor = order.type === 'buy' ? 'text-green-600' : 'text-red-600';
                return `<div class="flex justify-between items-center p-2 border-b border-gray-200"><div><span class="font-bold ${typeColor}">${typeText}</span> <span class="ml-2">${stock.icon} ${stock.name}</span> <span class="ml-2 text-gray-700">${order.quantity.toFixed(4)}주</span> <span class="ml-2 text-gray-500">@ ${formatCurrency(order.targetPrice)}</span></div><button class="cancel-order-btn text-xs bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-2 rounded" data-id="${order.id}">취소</button></div>`;
            }).join('');
            document.querySelectorAll('.cancel-order-btn').forEach(btn => btn.addEventListener('click', (e) => cancelOrder(parseInt(e.target.dataset.id))));
        }
        
        function handleInstantBuy() {
            const inputEl = document.getElementById('trade-input');
            const value = parseFloat(inputEl.value);
            const stock = state.stocks[state.activeStock];
            if (isNaN(value) || value <= 0) { showMessage('유효한 값을 입력하세요.'); return; }
            let quantityToBuy = 0, cost = 0;
            const currentPrice = stock.price;
            if (state.tradeMode === 'quantity') {
                quantityToBuy = value;
                cost = quantityToBuy * currentPrice;
            } else {
                cost = value;
                if (cost > state.balance) { showMessage('자산이 부족합니다.'); return; }
                quantityToBuy = cost / currentPrice;
            }
            if (state.balance < cost) { showMessage('자산이 부족합니다.'); return; }
            state.balance -= cost;
            stock.totalPurchaseCost += cost;
            stock.owned += quantityToBuy;
            showMessage(`${stock.name} ${quantityToBuy.toFixed(4)}주 즉시 매수 완료!`, 'success');
            inputEl.value = '';
            saveState();
            updateUI();
        }

        function handleInstantSell() {
            const inputEl = document.getElementById('trade-input');
            const value = parseFloat(inputEl.value);
            const stock = state.stocks[state.activeStock];
            if (isNaN(value) || value <= 0) { showMessage('유효한 값을 입력하세요.'); return; }
            
            let quantityToSell = 0;
            const currentPrice = stock.price;

            if (state.tradeMode === 'quantity') {
                quantityToSell = value;
            } else { // amount mode
                const userStockValue = stock.owned * currentPrice;
                if (value > userStockValue + 0.00001) {
                    showMessage(`보유 주식 가치(${formatCurrency(userStockValue)} 공기)를 초과하여 매도할 수 없습니다.`);
                    return;
                }
                quantityToSell = value / currentPrice;
            }

            if (stock.owned < quantityToSell - 0.00001) { 
                showMessage(`보유 수량이 부족합니다. (매도 시도: ${quantityToSell.toFixed(4)}주, 보유: ${stock.owned.toFixed(4)}주)`); 
                return; 
            }
            
            if (quantityToSell > stock.owned) { quantityToSell = stock.owned; }
            
            const revenue = quantityToSell * currentPrice;
            const avgCost = stock.owned > 0 ? stock.totalPurchaseCost / stock.owned : 0;
            const costOfSold = avgCost * quantityToSell;
            state.balance += revenue;
            stock.owned -= quantityToSell;
            stock.totalPurchaseCost -= costOfSold;
            if (stock.owned < 0.00001) { stock.owned = 0; stock.totalPurchaseCost = 0; }
            showMessage(`${stock.name} ${quantityToSell.toFixed(4)}주 즉시 매도 완료!`, 'success');
            inputEl.value = '';
            saveState();
            updateUI();
        }

        function handleLimitBuy() {
            const tradeInput = document.getElementById('trade-input');
            const limitPriceInput = document.getElementById('limit-price-input');
            const value = parseFloat(tradeInput.value);
            const limitPrice = parseFloat(limitPriceInput.value);
            if (isNaN(value) || value <= 0 || isNaN(limitPrice) || limitPrice <= 0) { showMessage('유효한 수량과 가격을 입력하세요.', 'error'); return; }
            let quantityToBuy = 0, cost = 0;
            if (state.tradeMode === 'quantity') {
                quantityToBuy = value;
                cost = quantityToBuy * limitPrice;
            } else {
                cost = value;
                quantityToBuy = cost / limitPrice;
            }
            if (state.balance < cost) { showMessage('자산이 부족하여 주문을 예약할 수 없습니다.', 'error'); return; }
            state.balance -= cost;
            const order = { id: Date.now(), stockId: state.activeStock, type: 'buy', quantity: quantityToBuy, targetPrice: limitPrice, amount: cost };
            state.pendingOrders.push(order);
            showMessage(`매수 주문이 예약되었습니다.`, 'success');
            tradeInput.value = '';
            saveState();
            updateUI();
        }

        function handleLimitSell() {
            const tradeInput = document.getElementById('trade-input');
            const limitPriceInput = document.getElementById('limit-price-input');
            const value = parseFloat(tradeInput.value);
            const limitPrice = parseFloat(limitPriceInput.value);
            if (isNaN(value) || value <= 0 || isNaN(limitPrice) || limitPrice <= 0) { showMessage('유효한 수량과 가격을 입력하세요.', 'error'); return; }
            
            const stock = state.stocks[state.activeStock];
            let quantityToSell = 0;
            
            if (state.tradeMode === 'quantity') {
                quantityToSell = value;
            } else { // amount mode
                const userStockValue = stock.owned * limitPrice;
                if (value > userStockValue + 0.00001) {
                     showMessage(`예약하려는 주식 가치(${formatCurrency(userStockValue)} 공기)를 초과하여 매도 예약할 수 없습니다.`);
                     return;
                }
                quantityToSell = value / limitPrice;
            }
            
            const pendingSellQuantity = state.pendingOrders.filter(o => o.stockId === state.activeStock && o.type === 'sell').reduce((sum, o) => sum + o.quantity, 0);
            if (stock.owned < pendingSellQuantity + quantityToSell - 0.00001) { 
                showMessage(`보유 및 예약 가능 수량이 부족합니다.`); 
                return; 
            }
            
            const order = { id: Date.now(), stockId: state.activeStock, type: 'sell', quantity: quantityToSell, targetPrice: limitPrice };
            state.pendingOrders.push(order);
            showMessage(`매도 주문이 예약되었습니다.`, 'success');
            tradeInput.value = '';
            saveState();
            updateUI();
        }
        
        function cancelOrder(orderId) {
            const orderIndex = state.pendingOrders.findIndex(o => o.id === orderId);
            if (orderIndex === -1) return;
            const order = state.pendingOrders[orderIndex];
            if (order.type === 'buy') { state.balance += order.amount; }
            state.pendingOrders.splice(orderIndex, 1);
            showMessage('주문이 취소되었습니다.', 'success');
            saveState();
            updateUI();
        }

        function processPendingOrders() {
            let stateChanged = false;
            const executedOrders = [];
            state.pendingOrders.forEach(order => {
                const stock = state.stocks[order.stockId];
                let executed = false;
                if (order.type === 'buy' && stock.price <= order.targetPrice) {
                    stock.owned += order.quantity;
                    stock.totalPurchaseCost += order.amount;
                    executed = true;
                } else if (order.type === 'sell' && stock.price >= order.targetPrice) {
                    const revenue = order.quantity * stock.price;
                    const avgCost = stock.owned > 0 ? stock.totalPurchaseCost / stock.owned : 0;
                    const costOfSold = avgCost * order.quantity;
                    state.balance += revenue;
                    stock.owned -= order.quantity;
                    stock.totalPurchaseCost -= costOfSold;
                    if (stock.owned < 0.00001) { stock.owned = 0; stock.totalPurchaseCost = 0; }
                    executed = true;
                }
                if (executed) {
                    executedOrders.push(order.id);
                    showMessage(`${stock.name} ${order.type === 'buy' ? '매수' : '매도'} 주문이 ${formatCurrency(stock.price)}에 체결!`, 'success');
                    stateChanged = true;
                }
            });
            if (stateChanged) {
                state.pendingOrders = state.pendingOrders.filter(o => !executedOrders.includes(o.id));
                saveState();
            }
        }
        
        function switchTimeframe(timeframe) { state.activeTimeframe = timeframe; updateUI(); }
        function switchTradeMode(mode) { if (state.tradeMode !== mode) { state.tradeMode = mode; updateUI(); } }
        function switchTab(stockId) { state.activeStock = stockId; state.activeTimeframe = '1M'; updateUI(); }

        function simulatePriceChange() {
            for (const stockId in state.stocks) {
                const stock = state.stocks[stockId];
                const lastTodayPrice = stock.todayHistory.length > 0 ? stock.todayHistory[stock.todayHistory.length - 1] : stock.fullHistory[stock.fullHistory.length - 1];
                const newTodayPrice = Math.max(1, lastTodayPrice + (Math.random() - 0.5) * 0.5);
                stock.todayHistory.push(newTodayPrice);
                if(stock.todayHistory.length > 24 * 60) stock.todayHistory.shift();
                stock.price = newTodayPrice;
            }
            processPendingOrders();
            if (document.getElementById('current-price')) { updateUI(); }
        }
        
        function setTradeInputByPercent(percent) {
            const inputEl = document.getElementById('trade-input');
            const stock = state.stocks[state.activeStock];
            if (!inputEl || !stock) return;
            let targetValue = 0;
            if (state.tradeMode === 'quantity') { targetValue = stock.owned * percent; } 
            else { targetValue = state.balance * percent; }
            const decimals = state.tradeMode === 'quantity' ? 4 : 2;
            inputEl.value = targetValue.toFixed(decimals);
        }
        
        function openAdminModalForCode() {
            adminModalTitle.textContent = '관리자 코드 입력';
            adminModalContent.innerHTML = `<label for="admin-code-input" class="block text-sm font-medium text-gray-700">코드를 입력하세요.</label><input type="password" id="admin-code-input" class="w-full px-3 py-2 mt-1 border rounded-md" autofocus><p id="admin-error" class="text-red-500 text-sm mt-1 h-4"></p><div class="mt-4 flex justify-end gap-2"><button type="button" id="admin-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">취소</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">확인</button></div>`;
            adminModalOverlay.classList.remove('hidden');
            adminForm.dataset.step = 'code';
        }
        function openAdminModalForAmount() {
            adminModalTitle.textContent = '자산 추가';
            adminModalContent.innerHTML = `<label for="admin-amount-input" class="block text-sm font-medium text-gray-700">추가할 금액(공기)을 입력하세요.</label><input type="number" id="admin-amount-input" step="any" min="0" class="w-full px-3 py-2 mt-1 border rounded-md" autofocus><p id="admin-error" class="text-red-500 text-sm mt-1 h-4"></p><div class="mt-4 flex justify-end gap-2"><button type="button" id="admin-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">취소</button><button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">추가</button></div>`;
            adminForm.dataset.step = 'amount';
        }
        function closeAdminModal() { adminModalOverlay.classList.add('hidden'); }
        function handleAdminFormSubmit(e) {
            e.preventDefault();
            const errorEl = document.getElementById('admin-error');
            errorEl.textContent = '';
            if (adminForm.dataset.step === 'code') {
                const codeInput = document.getElementById('admin-code-input');
                if (codeInput.value === state.adminCode) { openAdminModalForAmount(); } 
                else { errorEl.textContent = '코드가 일치하지 않습니다.'; }
            } else if (adminForm.dataset.step === 'amount') {
                const amountInput = document.getElementById('admin-amount-input');
                const amount = parseFloat(amountInput.value);
                if (!isNaN(amount) && amount > 0) {
                    state.balance += amount;
                    showMessage(`${formatCurrency(amount)} 공기가 추가되었습니다.`, 'success');
                    closeAdminModal();
                    saveState();
                    updateUI();
                } else { errorEl.textContent = '유효한 금액을 입력하세요.'; }
            }
        }

        function init() {
            loadState();
            state.stocks.usd.fullHistory = generateHistoricalData(730, 100, 1.5);
            state.stocks.oil.fullHistory = generateHistoricalData(730, 100, 2.5);
            state.stocks.usd.todayHistory = generateHistoricalData(8, state.stocks.usd.fullHistory[state.stocks.usd.fullHistory.length-1], 0.5);
            state.stocks.oil.todayHistory = generateHistoricalData(8, state.stocks.oil.fullHistory[state.stocks.oil.fullHistory.length-1], 0.8);
            state.stocks.usd.price = state.stocks.usd.todayHistory[state.stocks.usd.todayHistory.length - 1];
            state.stocks.oil.price = state.stocks.oil.todayHistory[state.stocks.oil.todayHistory.length - 1];
            tabUsdBtn.addEventListener('click', () => switchTab('usd'));
            tabOilBtn.addEventListener('click', () => switchTab('oil'));
            addAssetBtn.addEventListener('click', openAdminModalForCode);
            adminForm.addEventListener('submit', handleAdminFormSubmit);
            adminModalOverlay.addEventListener('click', (e) => {
                if (e.target === adminModalOverlay || e.target.id === 'admin-cancel-btn') { closeAdminModal(); }
            });
            switchTab('usd');
            setInterval(simulatePriceChange, 2000); // 업데이트 주기를 2초로 변경
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
